# –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–∞–ø–∞—Å–∞–º–∏

## –ü—Ä–æ–±–ª–µ–º–∞
–†–∞–Ω–µ–µ –≤ —Ñ–æ—Ä–º–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–æ–¥—É–∫—Ç–∞ –ø–æ–ª–µ `stock_quantity` –º–æ–∂–Ω–æ –±—ã–ª–æ –º–µ–Ω—è—Ç—å –Ω–∞–ø—Ä—è–º—É—é, —á—Ç–æ –ø—Ä–∏–≤–æ–¥–∏–ª–æ –∫ –∏–∑–º–µ–Ω–µ–Ω–∏—é –∑–∞–ø–∞—Å–æ–≤ –±–µ–∑ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –≤ —Ç–∞–±–ª–∏—Ü—É `stock_logs`. –≠—Ç–æ –Ω–∞—Ä—É—à–∞–ª–æ –∞—É–¥–∏—Ç –∏ –¥–µ–ª–∞–ª–æ –Ω–µ–≤–æ–∑–º–æ–∂–Ω—ã–º –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π.

## –†–µ—à–µ–Ω–∏–µ
–¢–µ–ø–µ—Ä—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–ø–∞—Å–∞–º–∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ—Ç–¥–µ–ª–µ–Ω–æ –æ—Ç –æ–±—ã—á–Ω–æ–≥–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–æ–¥—É–∫—Ç–∞:

### 1. **–û—Å–Ω–æ–≤–Ω–∞—è —Ñ–æ—Ä–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è** (`/admin/products/[id]/edit`)
- –†–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç: –Ω–∞–∑–≤–∞–Ω–∏–µ, —Ü–µ–Ω—É, –æ–ø–∏—Å–∞–Ω–∏–µ, –∫–∞—Ç–µ–≥–æ—Ä–∏—é, –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è, —Ç–µ–≥–∏, –±—Ä–µ–Ω–¥
- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å `inStock` (–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Ç–æ–≤–∞—Ä–∞) - —Ç–æ–ª—å–∫–æ –¥–ª—è –ø–æ–∫–∞–∑–∞ —Å—Ç–∞—Ç—É—Å–∞
- **–ù–ï —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç** `stock_quantity` –Ω–∞–ø—Ä—è–º—É—é

### 2. **–û—Ç–¥–µ–ª—å–Ω–∞—è —Å–µ–∫—Ü–∏—è "Lagerbestandsverwaltung"**
–ù–æ–≤–∞—è —Å–µ–∫—Ü–∏—è –Ω–∞ —Ç–æ–π –∂–µ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–∞–ø–∞—Å–∞–º–∏:

```typescript
// –ò—Å–ø–æ–ª—å–∑—É–µ—Ç endpoint: POST /api/admin/products/[id]/adjust-stock
{
  "quantityChange": +50,  // –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–µ –¥–ª—è –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è
  "reason": "Lieferung vom Lieferanten"
}

// –∏–ª–∏
{
  "quantityChange": -3,   // –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–µ –¥–ª—è —Å–ø–∏—Å–∞–Ω–∏—è
  "reason": "Besch√§digte Ware bei Inventur"
}
```

### 3. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**
–ö–∞–∂–¥–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –≤ —Ç–∞–±–ª–∏—Ü—É `stock_logs`:
- `product_id` - ID –ø—Ä–æ–¥—É–∫—Ç–∞
- `event_type: 'manual_adjust'`
- `quantity_change` - –∏–∑–º–µ–Ω–µ–Ω–∏–µ (+N / -N)
- `stock_before` - –∑–Ω–∞—á–µ–Ω–∏–µ –¥–æ
- `stock_after` - –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ—Å–ª–µ
- `notes` - –ø—Ä–∏—á–∏–Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è
- `created_at` - –≤—Ä–µ–º—è –æ–ø–µ—Ä–∞—Ü–∏–∏

**–ò** –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –≤ `audit_logs`:
- `action: 'product.update'`
- `metadata.operation: 'stock_adjusted'`
- –°–æ–¥–µ—Ä–∂–∏—Ç user_id –∞–¥–º–∏–Ω–∞, –∫–æ—Ç–æ—Ä—ã–π —Å–¥–µ–ª–∞–ª –∏–∑–º–µ–Ω–µ–Ω–∏–µ

## –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

### ‚úÖ –ü–æ–ª–Ω—ã–π –∞—É–¥–∏—Ç
–ö–∞–∂–¥–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –∑–∞–ø–∞—Å–æ–≤ —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç—Å—è —Å:
- –ö—Ç–æ –∏–∑–º–µ–Ω–∏–ª (admin user ID)
- –ö–æ–≥–¥–∞ –∏–∑–º–µ–Ω–∏–ª (timestamp)
- –°–∫–æ–ª—å–∫–æ –±—ã–ª–æ –¥–æ
- –°–∫–æ–ª—å–∫–æ —Å—Ç–∞–ª–æ –ø–æ—Å–ª–µ
- –ü—Ä–∏—á–∏–Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è

### ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç –æ—à–∏–±–æ–∫
- –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ —Å–ª—É—á–∞–π–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å –∑–∞–ø–∞—Å—ã –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –¥—Ä—É–≥–∏—Ö –ø–æ–ª–µ–π
- –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ "–ø—Ä–∏—á–∏–Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è"
- –í–∞–ª–∏–¥–∞—Ü–∏—è –Ω–∞ —É—Ä–æ–≤–Ω–µ API –∏ –ë–î

### ‚úÖ –ê—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å
`adjustStock()` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç PostgreSQL function `adjust_stock_manual`:
- `FOR UPDATE` –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —Å—Ç—Ä–æ–∫–∏
- –ü—Ä–æ–≤–µ—Ä–∫–∞ `stock >= 0` –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
- `RAISE EXCEPTION` –ø—Ä–∏ –æ—à–∏–±–∫–µ ‚Üí ROLLBACK —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏

## API

### –ó–∞–ø—Ä–µ—â–µ–Ω–æ —á–µ—Ä–µ–∑ –æ–±—ã—á–Ω—ã–π PUT/PATCH
```typescript
// ‚ùå –ù–ï –†–ê–ë–û–¢–ê–ï–¢ - stock_quantity —É–±—Ä–∞–Ω –∏–∑ allowed fields
PUT /api/admin/products/[id]
{
  "name": "Product Name",
  "stock_quantity": 100  // –±—É–¥–µ—Ç –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è!
}
```

### –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π —Å–ø–æ—Å–æ–±
```typescript
// ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û
POST /api/admin/products/[id]/adjust-stock
{
  "quantityChange": +50,    // –∏–ª–∏ -3
  "reason": "Nachlieferung erhalten"
}

// Response:
{
  "success": true,
  "newStock": 150,
  "stockBefore": 100,
  "productName": "Vitamin C Serum"
}
```

## UI/UX

### –î–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Lagerbestand: [____100____]     ‚îÇ  ‚Üê –ø—Ä—è–º–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ
‚îÇ ‚òë Produkt ist verf√ºgbar         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### –ü–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –û—Å–Ω–æ–≤–Ω–∞—è —Ñ–æ—Ä–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è                       ‚îÇ
‚îÇ Name: [__________________]                          ‚îÇ
‚îÇ Preis: [__________________]                         ‚îÇ
‚îÇ ‚òë Produkt ist verf√ºgbar    ‚Üê —Ç–æ–ª—å–∫–æ —Å—Ç–∞—Ç—É—Å         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ üì¶ Lagerbestandsverwaltung                          ‚îÇ
‚îÇ                                                     ‚îÇ
‚îÇ Aktueller Bestand: 100 Einheiten                   ‚îÇ
‚îÇ                                                     ‚îÇ
‚îÇ √Ñnderung: [___+50___] (+ hinzuf√ºgen, - entfernen) ‚îÇ
‚îÇ                                                     ‚îÇ
‚îÇ Grund: [_Lieferung vom Lieferanten_____________]   ‚îÇ
‚îÇ                                                     ‚îÇ
‚îÇ [ Bestand anpassen ]  ‚Üê —Å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## –ú–∏–≥—Ä–∞—Ü–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö
–ù–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è - —Ç–µ–∫—É—â–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è `stock_quantity` —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è.

## Database Schema

### –¢–∞–±–ª–∏—Ü–∞ `stock_logs`
```sql
CREATE TABLE stock_logs (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    product_id UUID NOT NULL REFERENCES products(id),
    order_id UUID REFERENCES orders(id),
    event_type TEXT NOT NULL,  -- 'purchase' | 'refund' | 'manual_adjust' | 'cancelled'
    quantity_change INTEGER NOT NULL,
    stock_before INTEGER NOT NULL,
    stock_after INTEGER NOT NULL,
    payment_id TEXT,
    notes TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW()
);
```

### –§—É–Ω–∫—Ü–∏—è `adjust_stock_manual`
```sql
CREATE OR REPLACE FUNCTION adjust_stock_manual(
    p_product_id UUID,
    p_quantity_change INTEGER,
    p_reason TEXT,
    p_admin_user_id UUID
) RETURNS TABLE(
    product_name TEXT,
    stock_before INTEGER,
    stock_after INTEGER
) AS $$
BEGIN
    -- FOR UPDATE –±–ª–æ–∫–∏—Ä—É–µ—Ç —Å—Ç—Ä–æ–∫—É
    -- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —á—Ç–æ –Ω–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ >= 0
    -- –°–æ–∑–¥–∞—ë—Ç –∑–∞–ø–∏—Å—å –≤ stock_logs
    -- RAISE EXCEPTION –µ—Å–ª–∏ –æ—à–∏–±–∫–∞
END;
$$ LANGUAGE plpgsql;
```

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### 1. –ü–æ–ø—ã—Ç–∫–∞ –∏–∑–º–µ–Ω–∏—Ç—å stock_quantity —á–µ—Ä–µ–∑ PUT
```bash
curl -X PUT http://localhost:3000/api/admin/products/123 \
  -H "Content-Type: application/json" \
  -d '{"stock_quantity": 999}'

# –†–µ–∑—É–ª—å—Ç–∞—Ç: stock_quantity –Ω–µ –∏–∑–º–µ–Ω–∏—Ç—Å—è (ignored)
```

### 2. –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ —á–µ—Ä–µ–∑ adjust-stock
```bash
curl -X POST http://localhost:3000/api/admin/products/123/adjust-stock \
  -H "Content-Type: application/json" \
  -d '{
    "quantityChange": 50,
    "reason": "Test inventory increase"
  }'

# –†–µ–∑—É–ª—å—Ç–∞—Ç: stock –∏–∑–º–µ–Ω–∏—Ç—Å—è, —Å–æ–∑–¥–∞—Å—Ç—Å—è –∑–∞–ø–∏—Å—å –≤ stock_logs
```

### 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤
```sql
SELECT 
    sl.created_at,
    sl.event_type,
    sl.quantity_change,
    sl.stock_before,
    sl.stock_after,
    sl.notes,
    p.name as product_name
FROM stock_logs sl
JOIN products p ON p.id = sl.product_id
WHERE sl.product_id = '123'
ORDER BY sl.created_at DESC;
```

## –°–≤—è–∑–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
- `app/admin/products/[id]/edit/page.tsx` - —Ñ–æ—Ä–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
- `app/api/admin/products/[id]/route.ts` - –æ—Å–Ω–æ–≤–Ω–æ–π CRUD (–±–µ–∑ stock)
- `app/api/admin/products/[id]/adjust-stock/route.ts` - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–ø–∞—Å–∞–º–∏
- `lib/inventory/stock-manager.ts` - —Ñ—É–Ω–∫—Ü–∏—è `adjustStock()`
- `supabase/migrations/add_inventory_management.sql` - —Å—Ö–µ–º–∞ –ë–î

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
–°–º. —Ç–∞–∫–∂–µ:
- `MD/ADMIN_STOCK_MANAGEMENT.md` - –æ–±—â–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—é –∑–∞–ø–∞—Å–∞–º–∏
- `MD/ATOMIC_STOCK_INSTALLATION.md` - —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∞—Ç–æ–º–∞—Ä–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- `MD/RACE_CONDITION_PROTECTION.md` - –∑–∞—â–∏—Ç–∞ –æ—Ç race conditions
