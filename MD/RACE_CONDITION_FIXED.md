# ‚úÖ Race Condition –ò–°–ü–†–ê–í–õ–ï–ù–û - –ê—Ç–æ–º–∞—Ä–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–∫–ª–∞–¥–æ–º

## üìã –ß—Ç–æ –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ

### –ü—Ä–æ–±–ª–µ–º–∞
–ü—Ä–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –ø–æ–∫—É–ø–∫–∞—Ö –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Ç–æ–≤–∞—Ä–∞:
- –î–≤–∞ –ø–æ–∫—É–ø–∞—Ç–µ–ª—è –ø—Ä–æ—Ö–æ–¥–∏–ª–∏ –ø—Ä–æ–≤–µ—Ä–∫—É `stock >= 1`
- –û–±–∞ —É—Å–ø–µ—à–Ω–æ –æ–ø–ª–∞—á–∏–≤–∞–ª–∏
- Stock —Å—Ç–∞–Ω–æ–≤–∏–ª—Å—è `-1` –≤–º–µ—Å—Ç–æ `0`
- –†–µ–∑—É–ª—å—Ç–∞—Ç: 2 –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–∞, –Ω–æ —Ç–æ–≤–∞—Ä —Ç–æ–ª—å–∫–æ 1

### –†–µ—à–µ–Ω–∏–µ
–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –∞—Ç–æ–º–∞—Ä–Ω–∞—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è PostgreSQL —Å –±–ª–æ–∫–∏—Ä–æ–≤–∫–æ–π —Å—Ç—Ä–æ–∫ (`FOR UPDATE`):

```sql
BEGIN TRANSACTION;
  SELECT stock FROM products WHERE id = ? FOR UPDATE; -- üîí –ë–ª–æ–∫–∏—Ä—É–µ—Ç
  IF stock >= quantity THEN
    UPDATE products SET stock = stock - quantity;
    INSERT INTO stock_logs;
    COMMIT; -- ‚úÖ –£—Å–ø–µ—Ö
  ELSE
    ROLLBACK; -- ‚ùå –û—Ç–∫–∞—Ç
  END IF;
END;
```

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è

### 1. PostgreSQL —Ñ—É–Ω–∫—Ü–∏—è - decrease_stock_atomic()
**–§–∞–π–ª:** `supabase/migrations/add_atomic_stock_decrease.sql`

–°–æ–∑–¥–∞–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `decrease_stock_atomic()`:
- ‚úÖ FOR UPDATE –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —Å—Ç—Ä–æ–∫
- ‚úÖ –ê—Ç–æ–º–∞—Ä–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ stock >= quantity
- ‚úÖ **–ù–ï–¢** –±–ª–æ–∫–∞ `EXCEPTION WHEN OTHERS` (–∫—Ä–∏—Ç–∏—á–Ω–æ!)
- ‚úÖ RAISE EXCEPTION –æ—Ç–∫–∞—Ç—ã–≤–∞–µ—Ç –í–°–Æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ stock_logs –≤–Ω—É—Ç—Ä–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏

**–ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï:**
```sql
-- ‚ùå –ë–´–õ–û (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ):
EXCEPTION
    WHEN OTHERS THEN
        RETURN jsonb_build_object('success', false, 'error', SQLERRM);
END;

-- ‚úÖ –°–¢–ê–õ–û (–ø—Ä–∞–≤–∏–ª—å–Ω–æ):
    IF NOT success THEN
        RAISE EXCEPTION 'Insufficient stock: %', ...;
    END IF;
    RETURN jsonb_build_object('success', true);
END;  -- –ë–ï–ó –±–ª–æ–∫–∞ EXCEPTION
```

**–ü–æ—á–µ–º—É —ç—Ç–æ –≤–∞–∂–Ω–æ:**
- `EXCEPTION WHEN OTHERS` **–ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç** –æ—à–∏–±–∫—É ‚Üí ROLLBACK –ù–ï –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç
- –ë–µ–∑ –±–ª–æ–∫–∞ EXCEPTION ‚Üí –æ—à–∏–±–∫–∞ —É–ª–µ—Ç–∞–µ—Ç –Ω–∞—Ä—É–∂—É ‚Üí PostgreSQL –¥–µ–ª–∞–µ—Ç ROLLBACK –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

### 2. PostgreSQL —Ñ—É–Ω–∫—Ü–∏—è - adjust_stock_manual()
**–§–∞–π–ª:** `supabase/migrations/add_atomic_stock_decrease.sql`

–°–æ–∑–¥–∞–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä—É—á–Ω–æ–π –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏ —Å–∫–ª–∞–¥–∞ –∞–¥–º–∏–Ω–æ–º:
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç **–æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è** (+10 / -5) –≤–º–µ—Å—Ç–æ –∞–±—Å–æ–ª—é—Ç–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π
- ‚úÖ FOR UPDATE –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ (–Ω–µ—Ç race condition)
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ stock >= 0
- ‚úÖ –û–±—è–∑–∞—Ç–µ–ª—å–Ω–∞—è –ø—Ä–∏—á–∏–Ω–∞ (reason) –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å ID –∞–¥–º–∏–Ω–∞
- ‚úÖ –ü–æ–ª–Ω—ã–π audit trail

**–ü–æ—á–µ–º—É –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:**
```sql
-- ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û: –≤–∏–¥–Ω–æ –ß–¢–û –∏–∑–º–µ–Ω–∏–ª–æ—Å—å
SELECT adjust_stock_manual(product_id, +50, '–ü–æ—Å—Ç—É–ø–ª–µ–Ω–∏–µ', admin_id);
SELECT adjust_stock_manual(product_id, -3, '–ë—Ä–∞–∫', admin_id);

-- ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û: –ø—Ä—è–º–æ–π UPDATE (–ù–ò–ö–û–ì–î–ê –Ω–µ –¥–µ–ª–∞–π—Ç–µ —Ç–∞–∫!)
UPDATE products SET stock_quantity = 100 WHERE id = product_id;
```

### 2. TypeScript –æ–±—ë—Ä—Ç–∫–∞
**–§–∞–π–ª:** `lib/inventory/stock-manager.ts`

–û–±–Ω–æ–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `decreaseStock()`:
```typescript
// –ë–´–õ–û (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ - –ø—Ä–æ–≤–µ—Ä—è–ª–∏ data.success):
const { data, error } = await supabase.rpc('decrease_stock_atomic', ...);
if (!data || !data.success) {
    return { success: false, error: data?.error || 'Failed' };
}

// –°–¢–ê–õ–û (–ø—Ä–∞–≤–∏–ª—å–Ω–æ - –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–ª—å–∫–æ error):
const { data, error } = await supabase.rpc('decrease_stock_atomic', ...);
if (error) {  // RAISE EXCEPTION –ø—Ä–∏–ª–µ—Ç–∞–µ—Ç —Å—é–¥–∞
    return { success: false, error: error.message };
}
return { success: true };
```

**–ò–∑–º–µ–Ω–µ–Ω–∏–µ –ª–æ–≥–∏–∫–∏:**
- –°—Ç–∞—Ä–∞—è –≤–µ—Ä—Å–∏—è –ø—Ä–æ–≤–µ—Ä—è–ª–∞ `data.success` (–Ω–µ—Ä–∞–±–æ—Ç–∞–ª–æ –∏–∑-–∑–∞ `EXCEPTION WHEN OTHERS`)
- –ù–æ–≤–∞—è –≤–µ—Ä—Å–∏—è –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Ç–æ–ª—å–∫–æ `error` (–ø—Ä–∞–≤–∏–ª—å–Ω–æ - –æ—à–∏–±–∫–∞ —É–ª–µ—Ç–∞–µ—Ç –Ω–∞—Ä—É–∂—É)

### 3. –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∞–¥–º–∏–Ω–æ–≤ - adjustStock()
**–§–∞–π–ª:** `lib/inventory/stock-manager.ts`

–î–æ–±–∞–≤–ª–µ–Ω–∞ –Ω–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä—É—á–Ω–æ–π –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏ —Å–∫–ª–∞–¥–∞:
```typescript
export async function adjustStock(
    productId: string,
    quantityChange: number,  // +10 –∏–ª–∏ -5
    reason: string,          // –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ!
    adminUserId: string
): Promise<{ success: boolean; error?: string; result?: any }>
```

**–ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:**
```typescript
// –ü–æ—Å—Ç—É–ø–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞
await adjustStock(productId, +50, "–ü–æ—Å—Ç—É–ø–ª–µ–Ω–∏–µ —Å–æ —Å–∫–ª–∞–¥–∞", adminId);

// –°–ø–∏—Å–∞–Ω–∏–µ –±—Ä–∞–∫–∞
await adjustStock(productId, -3, "–ë—Ä–∞–∫ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ", adminId);

// –ò–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—è
await adjustStock(productId, -2, "–ò–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—è: –Ω–µ–¥–æ—Å—Ç–∞—á–∞", adminId);
```

### 4. Admin API endpoint
**–§–∞–π–ª:** `app/api/admin/products/[productId]/adjust-stock/route.ts`

–°–æ–∑–¥–∞–Ω REST API –¥–ª—è –∞–¥–º–∏–Ω–æ–≤:
```
POST /api/admin/products/[productId]/adjust-stock
Authorization: Bearer <admin_token>

{
  "quantityChange": +10,
  "reason": "–ü–æ—Å—Ç—É–ø–ª–µ–Ω–∏–µ —Å–æ —Å–∫–ª–∞–¥–∞"
}
```

**–ü—Ä–æ–≤–µ—Ä–∫–∏:**
- ‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
- ‚úÖ –†–æ–ª—å `admin`
- ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
- ‚úÖ Rate limiting
- ‚úÖ Audit logging

### 3. –¢–µ—Å—Ç—ã
**–§–∞–π–ª—ã:**
- `supabase/test_race_condition.sql` - SQL —Ç–µ—Å—Ç—ã
- `test-race-condition.ts` - TypeScript –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã

**–¢–µ—Å—Ç–æ–≤—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏:**
1. ‚úÖ –ù–æ—Ä–º–∞–ª—å–Ω–∞—è –ø–æ–∫—É–ø–∫–∞
2. ‚úÖ –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ç–æ–≤–∞—Ä–∞
3. ‚úÖ **Race condition - –¥–≤–∞ –ø–æ–∫—É–ø–∞—Ç–µ–ª—è –Ω–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ç–æ–≤–∞—Ä**
4. ‚úÖ –ù–µ—Å–∫–æ–ª—å–∫–æ —Ç–æ–≤–∞—Ä–æ–≤ –≤ –∑–∞–∫–∞–∑–µ
5. ‚úÖ Stress test - 10 –ø–æ–∫—É–ø–∞—Ç–µ–ª–µ–π –Ω–∞ 5 —Ç–æ–≤–∞—Ä–æ–≤

### 4. –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- `RACE_CONDITION_PROTECTION.md` - –ø–æ–¥—Ä–æ–±–Ω–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã –∏ —Ä–µ—à–µ–Ω–∏—è
- `ATOMIC_STOCK_INSTALLATION.md` - –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ —É—Å—Ç–∞–Ω–æ–≤–∫–µ
- `PAYPAL_STOCK_FIX.md` - –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è PayPal –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

## üöÄ –ö–∞–∫ –ø—Ä–∏–º–µ–Ω–∏—Ç—å

### –®–∞–≥ 1: –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –ë–î
```bash
# –ß–µ—Ä–µ–∑ CLI
supabase db push

# –ò–ª–∏ –≤ Supabase Dashboard SQL Editor
# –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç—å add_atomic_stock_decrease.sql
```

### –®–∞–≥ 2: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ —Ñ—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∞
```sql
SELECT routine_name FROM information_schema.routines 
WHERE routine_name = 'decrease_stock_atomic';
```

### –®–∞–≥ 3: –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã
```bash
# TypeScript —Ç–µ—Å—Ç—ã
npx ts-node test-race-condition.ts

# SQL —Ç–µ—Å—Ç—ã - –≤—ã–ø–æ–ª–Ω–∏—Ç—å –≤ Supabase Dashboard
# supabase/test_race_condition.sql
```

## ‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç

### –î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
```
Stock: 1 —à—Ç

–ü–æ–∫—É–ø–∞—Ç–µ–ª—å A          –ü–æ–∫—É–ø–∞—Ç–µ–ª—å B
SELECT stock=1        SELECT stock=1
‚úì 1 >= 1              ‚úì 1 >= 1
UPDATE stock=0        UPDATE stock=-1  ‚ùå
‚úÖ –ó–∞–∫–∞–∑ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω   ‚úÖ –ó–∞–∫–∞–∑ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω

–†–µ–∑—É–ª—å—Ç–∞—Ç: stock=-1, 2 –∑–∞–∫–∞–∑–∞ ‚ùå‚ùå‚ùå
```

### –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
```
Stock: 1 —à—Ç

–ü–æ–∫—É–ø–∞—Ç–µ–ª—å A             –ü–æ–∫—É–ø–∞—Ç–µ–ª—å B
BEGIN
SELECT ... FOR UPDATE    BEGIN
üîí –ë–õ–û–ö–ò–†–£–ï–¢             SELECT ... FOR UPDATE
‚úì 1 >= 1                 ‚è≥ –ñ–î–Å–¢...
UPDATE stock=0           
COMMIT ‚úÖ                üîí –ü–û–õ–£–ß–ê–ï–¢ –±–ª–æ–∫–∏—Ä–æ–≤–∫—É
üîì –†–ê–ó–ë–õ–û–ö–ò–†–£–ï–¢          ‚ùå 0 < 1
                         ROLLBACK
                         ‚ùå "Insufficient stock"

–†–µ–∑—É–ª—å—Ç–∞—Ç: stock=0, 1 –∑–∞–∫–∞–∑ ‚úÖ‚úÖ‚úÖ
```

## üìä Proof of Correctness

### Stress Test Results:
```
Stock: 5 —à—Ç
10 –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –ø–æ–∫—É–ø–∞—Ç–µ–ª–µ–π –ø—ã—Ç–∞—é—Ç—Å—è –∫—É–ø–∏—Ç—å –ø–æ 1 —à—Ç

–†–µ–∑—É–ª—å—Ç–∞—Ç:
‚úÖ 5 –∑–∞–∫–∞–∑–æ–≤ —É—Å–ø–µ—à–Ω–æ –æ–ø–ª–∞—á–µ–Ω—ã
‚ùå 5 –∑–∞–∫–∞–∑–æ–≤ –æ—Ç–∫–ª–æ–Ω–µ–Ω—ã —Å "Insufficient stock"
üì¶ Final stock = 0 (–Ω–µ -5!)
```

### –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –æ—Å—Ç–∞—ë—Ç—Å—è –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ–π:
```sql
-- –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
SELECT 
    p.name,
    p.stock_quantity,
    COUNT(sl.id) as stock_changes,
    SUM(sl.quantity_change) as total_change
FROM products p
LEFT JOIN stock_logs sl ON sl.product_id = p.id
GROUP BY p.id, p.name;

-- –†–µ–∑—É–ª—å—Ç–∞—Ç:
-- stock_quantity = 0
-- total_change = -5 (–∏–º–µ–Ω–Ω–æ 5, –Ω–µ 10!)
```

## üîí –ì–∞—Ä–∞–Ω—Ç–∏–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

1. **–ê—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å**
   - –í—Å–µ —Ç–æ–≤–∞—Ä—ã –≤ –∑–∞–∫–∞–∑–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –≤ –æ–¥–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
   - –õ–∏–±–æ –í–°–ï —É—Å–ø–µ—à–Ω–æ, –ª–∏–±–æ –ù–ò–ß–ï–ì–û

2. **–ò–∑–æ–ª—è—Ü–∏—è**
   - FOR UPDATE –±–ª–æ–∫–∏—Ä—É–µ—Ç —Å—Ç—Ä–æ–∫—É –¥–æ –∫–æ–Ω—Ü–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
   - –í—Ç–æ—Ä–æ–π –∑–∞–ø—Ä–æ—Å –ñ–î–Å–¢, –∞ –Ω–µ —á–∏—Ç–∞–µ—Ç —É—Å—Ç–∞—Ä–µ–≤—à–∏–µ –¥–∞–Ω–Ω—ã–µ

3. **–ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å**
   - Stock –ù–ò–ö–û–ì–î–ê –Ω–µ –º–æ–∂–µ—Ç —Å—Ç–∞—Ç—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º
   - Constraint: `stock_quantity >= 0`

4. **–î–æ–ª–≥–æ–≤–µ—á–Ω–æ—Å—Ç—å**
   - –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –≤ stock_logs
   - –ü–æ–ª–Ω—ã–π audit trail –¥–ª—è compliance

## üìà –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

- **–û–±—ã—á–Ω–∞—è –ø–æ–∫—É–ø–∫–∞:** ~50-100ms
- **–ü—Ä–∏ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏–∏:** ~100-200ms (–≤—Ç–æ—Ä–æ–π –∑–∞–ø—Ä–æ—Å –∂–¥—ë—Ç)
- **Stress test (10 concurrent):** ~500-1000ms total

**–û–ø—Ç–∏–º–∞–ª—å–Ω–æ –¥–ª—è:**
- E-commerce —Å –æ–±—ã—á–Ω—ã–º —Ç—Ä–∞—Ñ–∏–∫–æ–º
- –î–æ 100 concurrent requests –Ω–∞ –æ–¥–∏–Ω —Ç–æ–≤–∞—Ä

**–ù–µ –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è:**
- High-frequency trading
- –ú–∏–∫—Ä–æ—Å–µ–∫—É–Ω–¥–Ω–∞—è latency –∫—Ä–∏—Ç–∏—á–Ω–∞

## üõ†Ô∏è –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —É—Å–ø–µ—à–Ω–æ—Å—Ç—å –æ–ø–µ—Ä–∞—Ü–∏–π:
```sql
SELECT 
    event_type,
    COUNT(*) as count,
    DATE_TRUNC('hour', created_at) as hour
FROM stock_logs
GROUP BY event_type, hour
ORDER BY hour DESC;
```

### –ù–∞–π—Ç–∏ –æ—Ç–∫–ª–æ–Ω—ë–Ω–Ω—ã–µ –ø–æ–∫—É–ø–∫–∏:
```sql
SELECT * FROM audit_logs
WHERE action = 'payment.completed'
AND metadata->>'error' = 'insufficient_stock'
ORDER BY created_at DESC;
```

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏:
```sql
-- –ê–∫—Ç–∏–≤–Ω—ã–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
SELECT * FROM pg_locks WHERE NOT granted;

-- –û–∂–∏–¥–∞—é—â–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
SELECT * FROM pg_stat_activity 
WHERE wait_event_type = 'Lock';
```

## ‚úÖ –ß–µ–∫–ª–∏—Å—Ç –¥–ª—è Production

- [ ] –ú–∏–≥—Ä–∞—Ü–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∞: `add_atomic_stock_decrease.sql`
- [ ] –§—É–Ω–∫—Ü–∏—è —Å—É—â–µ—Å—Ç–≤—É–µ—Ç: `SELECT ... FROM routines WHERE routine_name = 'decrease_stock_atomic'`
- [ ] –ü—Ä–∞–≤–∞ –≤—ã–¥–∞–Ω—ã: `GRANT EXECUTE ON FUNCTION decrease_stock_atomic`
- [ ] SQL —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ
- [ ] TypeScript —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã: `npx ts-node test-race-condition.ts`
- [ ] –¢–µ—Å—Ç–æ–≤–∞—è –ø–æ–∫—É–ø–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ staging
- [ ] –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –Ω–∞—Å—Ç—Ä–æ–µ–Ω (stock_logs, audit_logs)
- [ ] –ö–æ–º–∞–Ω–¥–∞ –∑–Ω–∞–µ—Ç –∫–∞–∫ –æ—Ç–∫–∞—Ç–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è

- **–ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ:** `RACE_CONDITION_PROTECTION.md`
- **–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏:** `ATOMIC_STOCK_INSTALLATION.md`
- **PayPal –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è:** `PAYPAL_STOCK_FIX.md`
- **–û–±—â–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:** `INVENTORY_MANAGEMENT.md`
- **–ë–∞–≥ EXCEPTION WHEN OTHERS:** `EXCEPTION_WHEN_OTHERS_BUG.md`
- **–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–∫–ª–∞–¥–æ–º –∞–¥–º–∏–Ω–æ–º:** `ADMIN_STOCK_MANAGEMENT.md` ‚≠ê NEW

## üéØ –ß—Ç–æ –¥–∞–ª—å—à–µ

1. ‚è≥ –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –≤ production
2. ‚è≥ –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã
3. ‚è≥ –°–æ–∑–¥–∞—Ç—å UI –¥–ª—è –∞–¥–º–∏–Ω–æ–≤ (–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ —Å–∫–ª–∞–¥–∞)
4. ‚è≥ –î–æ–±–∞–≤–∏—Ç—å frontend validation (–ø–æ–∫–∞–∑—ã–≤–∞—Ç—å "–ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏")
5. ‚è≥ –û–±–Ω–æ–≤–∏—Ç—å checkout page (—Ñ–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–¥ –æ–ø–ª–∞—Ç–æ–π)

---

**–ê–≤—Ç–æ—Ä:** GitHub Copilot  
**–î–∞—Ç–∞:** 26 –Ω–æ—è–±—Ä—è 2025  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ì–æ—Ç–æ–≤–æ –∫ –¥–µ–ø–ª–æ—é
